{% extends 'base.html' %}
{% block title %}Opt de Compras de Carbón{% endblock %}

{% block content %}
<div class="container py-4">

  <h2 class="mb-4 text-center fs-2">🧮 Modelo de Optimización de Compras de Carbón</h2>

  <form method="POST" enctype="multipart/form-data">
    <!-- Sección 1: Cargar archivo -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">📥 Cargar datos</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Archivo de datos (.xlsx):</label>
          <input class="form-control" type="file" name="archivo"
            {% if not session.get('archivo_path') %}required{% endif %}>
          {% if session.get('archivo_path') %}
            <small class="text-success">📁 Archivo cargado: {{ session['archivo_path'].split('/')[-1] }}</small>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sección 2: Parámetros -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">⚙️ Parámetros del modelo</div>
      <div class="card-body">
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="solo_mineros" id="solo_mineros"
           {% if solo_mineros %}checked{% endif %}>
          <label class="form-check-label" for="solo_mineros">✅ Solo incluir mineros</label>
        </div>

        <div class="mb-4">
          <label for="limite" class="form-label">
            🔒 Límite de participación de comercializadores: 
            <span id="valor_limite">{{ limite_comercializadores }}</span>%
          </label>
          <input type="range" class="form-range" name="limite" id="limite"
                min="0" max="100" value="{{ limite_comercializadores }}"
                oninput="document.getElementById('valor_limite').innerText = this.value">
        </div>

        <div class="mb-2">
          <label class="form-label">🎯 Criterio de optimización:</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="modelo" id="modelo_precio" value="precio"
            {% if modelo_usado != 'costo_ccb' %}checked{% endif %}>
            <label class="form-check-label" for="modelo_precio">Minimizar Precio</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="modelo" id="modelo_costo_ccb" value="costo_ccb"
            {% if modelo_usado == 'costo_ccb' %}checked{% endif %}>
            <label class="form-check-label" for="modelo_costo_ccb">Minimizar Costo CCB</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón ejecutar -->
    <div class="text-center mb-5" enctype="multipart/form-data">
      <button class="btn btn-lg btn-primary">🚀 Ejecutar modelo</button>
    </div>
  </form>

  {% if estado %}
  <!-- Resultados -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">✅ Resultados del modelo</div>
    <div class="card-body">
      <h5>📌 Estado del modelo: {{ estado }}</h5>
      <h5>🧠 Criterio de optimización usado: {{ 'Costo CCB' if modelo_usado == 'costo_ccb' else 'Precio' }}</h5>
      <a href="{{ url_for('optimizacion.descargar_excel') }}" class="btn btn-success my-3">📥 Descargar resultados en Excel</a>
    </div>
  </div>

  <div class="mb-4">
    <h5>📊 Tabla de resultados</h5>
    {{ tabla_resultados|safe }}
  </div>

  <div class="mb-5">
    <h5>📈 Calidad y rendimiento alcanzado</h5>
    {{ tabla_resumen|safe }}
  </div>

  <!-- Gráficos -->
  <div class="text-center mt-5">
    <h5>Distribución por tipo de carbón</h5>
    <img src="data:image/png;base64,{{ grafico_torta }}" class="img-fluid" style="width: 50%; height: auto;">
  </div>

  <div class="mt-5">
    <h5 class="text-center">Compra óptima por mina y pila</h5>
    <div class="d-flex justify-content-center">
      <img src="data:image/png;base64,{{ grafico_barras }}" class="img-fluid" style="width: 100%; max-width: 1200px;">
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function () {
      $('#tabla_resultados').DataTable();
    });
  </script>
  {% endif %}

</div>
{% endblock %}
