{% extends 'base.html' %}
{% block title %}Destajos App{% endblock %}
{% block content %}
<div class="p-6 space-y-8">
  
  <!-- Encabezado -->
  <div class="text-center">
    <h1 class="text-2xl font-bold mb-2">Registro de Destajos</h1>
    <p class="text-gray-600">Agrega nuevos registros...</p>
  </div>

  <!-- Bloque de Registro -->
  <div x-init="initDB()"> <!-- IndexedDB abre al cargar -->
    <div x-data="destajosForm()" class="bg-white rounded-2xl shadow p-6 max-w-full overflow-hidden relative">
      <h2 class="text-xl font-semibold mb-4">Nuevo registro</h2>
      <form @submit.prevent="submit()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- Planta -->
        <div>
          <label class="block text-sm">Planta</label>
          <select x-model="planta" @change="onPlantaChange()" class="w-full border rounded p-2">
            <option value="">Seleccione…</option>
            <template x-for="p in plantas" :key="p.Planta">
              <option :value="p.Planta" x-text="p.nombre || p.Planta"></option>
            </template>
          </select>
          <span class="text-red-500 text-sm" x-text="errores.planta"></span>
        </div>

        <!-- Empleado -->
        <div>
          <label class="block text-sm">Empleado (nombre)</label>
          <select x-model="empleado_nombre" @change="asignarDocumento" class="w-full border rounded p-2">
            <template x-for="(e, index) in empleados" :key="e.documento || index">
              <option :value="e.nombre" x-text="e.nombre"></option>
            </template>
          </select>
          <span class="text-red-500 text-sm" x-text="errores.empleado_nombre"></span>
        </div>

        <!-- Documento -->
        <div>
          <label class="block text-sm">Documento</label>
          <input x-model="empleado_documento"
                 readonly
                 class="w-full border rounded p-2 bg-gray-100">
          <span class="text-red-500 text-sm" x-text="errores.empleado_documento"></span>
        </div>

        <!-- Destajo -->
        <div>
          <label class="block text-sm">Destajo</label>
          <select x-model.number="destajo_id" class="w-full border rounded p-2">
            <template x-for="(d, index) in destajos" :key="d.id || index">
              <option :value="d.id" x-text="d.concepto"></option>
            </template>
          </select>
          <span class="text-red-500 text-sm" x-text="errores.destajo"></span>
        </div>

        <!-- Cantidad -->
        <div>
          <label class="block text-sm">Cantidad</label>
          <input type="number" step="0.1" min="1" x-model.number="cantidad" class="w-full border rounded p-2">
          <span class="text-red-500 text-sm" x-text="errores.cantidad"></span>
        </div>

        <!-- Fecha -->
        <div>
          <label class="block text-sm">Fecha</label>
          <input type="date" x-model="fecha" class="w-full border rounded p-2">
          <span class="text-red-500 text-sm" x-text="errores.fecha"></span>
        </div>

        <!-- Guardar y Buscar -->
        <div class="flex items-end space-x-2 p-4">
          <button class="px-4 py-2 bg-sky-600 text-white rounded hover:bg-sky-700 w-full md:w-28">
            Guardar
          </button>

          <a href="{{ url_for('web.consultar') }}" 
            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 md:w-28 text-center">
            Buscar
          </a>
        </div>
      </form>

      <!-- Toast de éxito -->
      <div 
        x-show="showSuccess"
        x-transition.opacity.duration.500ms
        class="fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50"
      >
        ✅ Registro guardado
      </div>
    </div>
  </div>
</div>
{% endblock %}
